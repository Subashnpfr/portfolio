<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digambar AI - Single File Edition</title>
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 20px; }
        .katex { font-size: 1.15em; color: #1e293b; }
        .katex-display { 
            margin: 1.5em 0; 
            padding: 1.25em; 
            background: #fdfdff; 
            border-radius: 20px; 
            border: 1px solid #f1f5f9;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            overflow-x: auto;
        }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Helper Icon Component for Single File ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        attrs: {
                            'stroke-width': 2.5,
                            'width': size,
                            'height': size
                        },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, icon }) => {
            const base = "flex items-center justify-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 shadow-sm",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-95",
                ghost: "text-slate-500 hover:bg-slate-100",
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
                    {icon && <Icon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        const MathSpan = ({ tex, display = false }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.katex && containerRef.current) {
                    try {
                        window.katex.render(tex, containerRef.current, {
                            throwOnError: false,
                            displayMode: display,
                            trust: true
                        });
                    } catch (e) {
                        containerRef.current.textContent = tex;
                    }
                }
            }, [tex, display]);
            return <span ref={containerRef} className={display ? "block" : "inline-block"} />;
        };

        function App() {
            const [apiKey, setApiKey] = useState("");
            const [query, setQuery] = useState("");
            const [image, setImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [messages, setMessages] = useState([
                { 
                    role: 'assistant', 
                    content: 'Hello! I am **Digambar AI**. You can Paste (Ctrl+V) images or upload files to solve math step-by-step.',
                    timestamp: new Date().toLocaleTimeString()
                }
            ]);
            const [isLoading, setIsLoading] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('digambar_api_key');
                if (savedKey) setApiKey(savedKey);
                else setShowSettings(true);
            }, []);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages, isLoading]);

            const processFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    setImage(file);
                    const reader = new FileReader();
                    reader.onloadend = () => setImagePreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        processFile(items[i].getAsFile());
                        break;
                    }
                }
            };

            const solveMath = async () => {
                if (!query.trim() && !image) return;
                if (!apiKey) { setShowSettings(true); return; }

                const userMessage = { role: 'user', content: query, image: imagePreview, timestamp: new Date().toLocaleTimeString() };
                setMessages(prev => [...prev, userMessage]);
                const currentQuery = query;
                const currentImage = imagePreview;
                
                setQuery(""); setImage(null); setImagePreview(null);
                setIsLoading(true);

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: currentQuery || "Solve the problem in this image step-by-step." },
                                    ...(currentImage ? [{ inlineData: { mimeType: "image/png", data: currentImage.split(',')[1] } }] : [])
                                ]
                            }],
                            systemInstruction: { parts: [{ text: "You are Digambar AI. Provide structured math solutions. Wrap math in $...$ or $$...$$. Use Steps." }] }
                        })
                    });

                    const data = await response.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error processing request.";
                    setMessages(prev => [...prev, { role: 'assistant', content: aiResponse, timestamp: new Date().toLocaleTimeString() }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'assistant', content: "Error connecting to AI. Check your key.", timestamp: new Date().toLocaleTimeString() }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const parseContent = (text) => {
                if (!text) return null;
                const parts = text.split(/(\$\$.*?\$\$|\$.*?\$)/gs);
                return parts.map((part, i) => {
                    if (part.startsWith('$$')) return <MathSpan key={i} tex={part.slice(2, -2)} display={true} />;
                    if (part.startsWith('$')) return <MathSpan key={i} tex={part.slice(1, -1)} display={false} />;
                    return <span key={i} dangerouslySetInnerHTML={{ __html: part.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} />;
                });
            };

            return (
                <div className="min-h-screen flex flex-col" onPaste={handlePaste}>
                    <header className="h-16 border-b bg-white/80 backdrop-blur-md flex items-center justify-between px-6 sticky top-0 z-50">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 p-1.5 rounded-lg text-white shadow-lg shadow-indigo-100">
                                <Icon name="plus" size={20} />
                            </div>
                            <span className="text-xl font-bold tracking-tight">Digambar <span className="text-indigo-600">AI</span></span>
                        </div>
                        <div className="flex gap-2">
                            <Button variant="ghost" onClick={() => setMessages([])} icon="trash-2" />
                            <Button variant="secondary" onClick={() => setShowSettings(true)} icon="settings">Config</Button>
                        </div>
                    </header>

                    <main className="flex-grow max-w-3xl w-full mx-auto p-4 pb-40">
                        <div ref={scrollRef} className="space-y-6">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`p-5 rounded-3xl max-w-[90%] shadow-sm border ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border-slate-200 rounded-tl-none'}`}>
                                        {msg.image && <img src={msg.image} className="rounded-xl mb-4 max-h-64 mx-auto" />}
                                        <div className="prose prose-slate">{msg.role === 'user' ? msg.content : parseContent(msg.content)}</div>
                                        <div className="mt-2 text-[10px] uppercase font-bold opacity-30 text-right">{msg.timestamp}</div>
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="bg-white border p-4 rounded-2xl flex items-center gap-3 w-fit shadow-sm">
                                    <div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Solving...</span>
                                </div>
                            )}
                        </div>
                    </main>

                    <footer className="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-50 to-transparent">
                        <div className="max-w-3xl mx-auto">
                            {imagePreview && (
                                <div className="mb-2 relative inline-block animate-in zoom-in duration-200">
                                    <img src={imagePreview} className="h-20 w-20 object-cover rounded-xl border-4 border-white shadow-xl" />
                                    <button onClick={() => setImagePreview(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg"><Icon name="x" size={12} /></button>
                                </div>
                            )}
                            <div className="bg-white rounded-3xl p-2 shadow-2xl border flex items-end ring-1 ring-slate-200/50">
                                <textarea
                                    value={query}
                                    onChange={e => setQuery(e.target.value)}
                                    onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); solveMath(); }}}
                                    placeholder="Paste image or type problem..."
                                    className="flex-grow p-4 bg-transparent outline-none resize-none max-h-40 font-medium"
                                    rows={1}
                                />
                                <div className="flex gap-1 pb-2 pr-2">
                                    <label className="p-3 text-slate-400 cursor-pointer hover:bg-slate-50 rounded-2xl"><Icon name="image" /><input type="file" className="hidden" onChange={e => processFile(e.target.files[0])} /></label>
                                    <Button onClick={solveMath} className="h-12 w-12 !p-0 rounded-2xl"><Icon name="send" size={22} /></Button>
                                </div>
                            </div>
                        </div>
                    </footer>

                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl border border-slate-100">
                                <h2 className="text-xl font-bold mb-4">API Config</h2>
                                <input 
                                    type="password" 
                                    value={apiKey} 
                                    onChange={e => setApiKey(e.target.value)} 
                                    className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:border-indigo-500 mb-4 font-mono"
                                    placeholder="Enter Gemini API Key"
                                />
                                <Button className="w-full py-4 rounded-2xl" onClick={() => { localStorage.setItem('digambar_api_key', apiKey); setShowSettings(false); }}>Save & Start</Button>
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="block text-center mt-4 text-xs text-indigo-600 underline">Get free key here</a>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
