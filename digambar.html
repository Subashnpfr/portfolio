<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digambar AI - Math Solver</title>
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 20px; }
        .katex { font-size: 1.15em; color: #1e293b; }
        .katex-display { 
            margin: 1.5em 0; 
            padding: 1.25em; 
            background: #fdfdff; 
            border-radius: 20px; 
            border: 1px solid #f1f5f9;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            overflow-x: auto;
        }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animate { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ======================================================================
        // GITHUB SECRET INTEGRATION
        // ======================================================================
        // This remains for your GitHub Actions workflow:
        // run: sed -i "s/const HARDCODED_API_KEY = \"\";/const HARDCODED_API_KEY = \"${{ secrets.HARDCODED_API_KEY }}\";/g" index.html
        const HARDCODED_API_KEY = ""; 
        
        // This is the variable used by the preview environment
        const apiKey = ""; 

        // logic to select the right key
        const FINAL_API_KEY = HARDCODED_API_KEY !== "" ? HARDCODED_API_KEY : apiKey;
        // ======================================================================

      

        // --- Helper Icon Component ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        attrs: {
                            'stroke-width': 2.5,
                            'width': size,
                            'height': size
                        },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size]);
            return <i data-lucide={name} className={className}></i>;
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, icon }) => {
            const base = "flex items-center justify-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 shadow-sm",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-95",
                ghost: "text-slate-500 hover:bg-slate-100",
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
                    {icon && <Icon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        const MathSpan = ({ tex, display = false }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.katex && containerRef.current) {
                    try {
                        window.katex.render(tex, containerRef.current, {
                            throwOnError: false,
                            displayMode: display,
                            trust: true
                        });
                    } catch (e) {
                        containerRef.current.textContent = tex;
                    }
                }
            }, [tex, display]);
            return <span ref={containerRef} className={display ? "block" : "inline-block"} />;
        };

        function App() {
            const [query, setQuery] = useState("");
            const [imagePreview, setImagePreview] = useState(null);
            const [messages, setMessages] = useState([
                { 
                    role: 'assistant', 
                    content: 'Hello! I am **Digambar AI**, powered by Google AI Studio. Send me a math problem or paste an image (Ctrl+V) to get started.',
                    timestamp: new Date().toLocaleTimeString()
                }
            ]);
            const [isLoading, setIsLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTo({
                        top: scrollRef.current.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, [messages, isLoading]);

            const processFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onloadend = () => setImagePreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        processFile(items[i].getAsFile());
                        break;
                    }
                }
            };

            const solveMath = async () => {
                if (!query.trim() && !imagePreview) return;

                // Simple check for missing key in UI (though backend handles the error)
                if (!FINAL_API_KEY && !window.location.hostname.includes('localhost')) {
                   // Continue anyway as the environment might inject it in a way the code doesn't see immediately
                }

                const userMessage = { 
                    role: 'user', 
                    content: query, 
                    image: imagePreview, 
                    timestamp: new Date().toLocaleTimeString() 
                };
                
                setMessages(prev => [...prev, userMessage]);
                
                const currentQuery = query;
                const currentImage = imagePreview;
                
                setQuery(""); 
                setImagePreview(null);
                setIsLoading(true);

                try {
                    const payload = {
                        contents: [{
                            parts: [
                                { text: currentQuery || "Please solve the math problem in this image step-by-step." },
                                ...(currentImage ? [{ inlineData: { mimeType: "image/png", data: currentImage.split(',')[1] } }] : [])
                            ]
                        }],
                        systemInstruction: { 
                            parts: [{ 
                                text: "You are Digambar AI, a professional math tutor from Google AI Studio. Solve problems step-by-step. Use LaTeX for math ($...$ for inline, $$...$$ for display). Be precise and clear." 
                            }] 
                        }
                    };

                    let response;
                    let retries = 5;
                    let delay = 1000;

                    for (let i = 0; i < retries; i++) {
                        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${FINAL_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break;
                        
                        // Handle errors
                        if (i < retries - 1 && (response.status === 429 || response.status >= 500)) {
                            await new Promise(r => setTimeout(r, delay));
                            delay *= 2;
                        } else {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                        }
                    }

                    const data = await response.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.";
                    
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: aiResponse, 
                        timestamp: new Date().toLocaleTimeString() 
                    }]);
                } catch (e) {
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: `**Error:** ${e.message}`, 
                        timestamp: new Date().toLocaleTimeString() 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const parseContent = (text) => {
                if (!text) return null;
                const parts = text.split(/(\$\$.*?\$\$|\$.*?\$)/gs);
                return parts.map((part, i) => {
                    if (part.startsWith('$$')) return <MathSpan key={i} tex={part.slice(2, -2)} display={true} />;
                    if (part.startsWith('$')) return <MathSpan key={i} tex={part.slice(1, -1)} display={false} />;
                    return <span key={i} dangerouslySetInnerHTML={{ 
                        __html: part.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                    }} />;
                });
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden bg-slate-50" onPaste={handlePaste}>
                    <header className="h-16 border-b bg-white flex items-center justify-between px-6 shrink-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 p-1.5 rounded-lg text-white">
                                <Icon name="bot" size={20} />
                            </div>
                            <span className="text-xl font-bold">Digambar <span className="text-indigo-600 font-extrabold tracking-tight">STUDIO</span></span>
                        </div>
                        <div className="flex items-center gap-3">
                            <Button variant="ghost" onClick={() => setMessages([messages[0]])} icon="refresh-cw">Reset</Button>
                        </div>
                    </header>

                    <main ref={scrollRef} className="flex-grow overflow-y-auto custom-scrollbar p-4 md:p-6">
                        <div className="max-w-3xl mx-auto space-y-6">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} message-animate`}>
                                    <div className={`p-5 rounded-3xl max-w-[90%] shadow-sm border ${
                                        msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none border-indigo-700' : 'bg-white border-slate-200 rounded-tl-none'
                                    }`}>
                                        {msg.image && <img src={msg.image} className="max-h-64 rounded-xl mb-4 border border-white/20 shadow-md" />}
                                        <div className="prose prose-slate max-w-none">
                                            {msg.role === 'user' ? msg.content : parseContent(msg.content)}
                                        </div>
                                        <div className="mt-2 text-[9px] uppercase font-bold tracking-widest opacity-30 text-right">{msg.timestamp}</div>
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start message-animate">
                                    <div className="bg-white border border-slate-200 p-4 rounded-2xl flex items-center gap-3 shadow-sm">
                                        <div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                        <span className="text-xs font-bold text-slate-400 uppercase tracking-tighter">Solving math...</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    <footer className="p-4 bg-white border-t shrink-0">
                        <div className="max-w-3xl mx-auto">
                            {imagePreview && (
                                <div className="mb-3 relative inline-block animate-in zoom-in duration-200">
                                    <img src={imagePreview} className="h-20 w-20 object-cover rounded-xl border border-slate-200 shadow-lg ring-4 ring-white" />
                                    <button onClick={() => setImagePreview(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 shadow-xl hover:bg-red-600 transition-colors">
                                        <Icon name="x" size={12} />
                                    </button>
                                </div>
                            )}
                            <div className="bg-slate-100 rounded-2xl p-2 flex items-end ring-1 ring-slate-200 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:bg-white transition-all shadow-inner">
                                <textarea
                                    value={query}
                                    onChange={e => setQuery(e.target.value)}
                                    onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); solveMath(); }}}
                                    placeholder="Type a problem or paste image..."
                                    className="flex-grow p-3 bg-transparent outline-none resize-none max-h-40 font-medium text-slate-700"
                                    rows={1}
                                />
                                <div className="flex gap-1 pb-1 pr-1">
                                    <label className="p-3 text-slate-400 cursor-pointer hover:bg-slate-200 hover:text-indigo-600 rounded-xl transition-all">
                                        <Icon name="paperclip" />
                                        <input type="file" className="hidden" accept="image/*" onChange={e => processFile(e.target.files[0])} />
                                    </label>
                                    <Button onClick={solveMath} disabled={isLoading || (!query.trim() && !imagePreview)} className="h-12 w-12 !p-0 rounded-xl shadow-indigo-200 shadow-lg">
                                        <Icon name="zap" size={22} />
                                    </Button>
                                </div>
                            </div>
                            <div className="mt-2 text-center">
                                <span className="text-[10px] text-slate-300 font-medium tracking-[0.2em] uppercase">Built with Gemini AI Studio</span>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
