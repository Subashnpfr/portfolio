<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digambar AI - Math Solver</title>
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 20px; }
        .katex { font-size: 1.15em; color: #1e293b; }
        .katex-display { 
            margin: 1.5em 0; 
            padding: 1.25em; 
            background: #fdfdff; 
            border-radius: 20px; 
            border: 1px solid #f1f5f9;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            overflow-x: auto;
        }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animate { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // API Configuration
        const apiKey = ""; // Handled by environment
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        // --- Helper Icon Component ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        attrs: {
                            'stroke-width': 2.5,
                            'width': size,
                            'height': size
                        },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size]);
            return <i data-lucide={name} className={className}></i>;
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, icon }) => {
            const base = "flex items-center justify-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 shadow-sm",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-95",
                ghost: "text-slate-500 hover:bg-slate-100",
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
                    {icon && <Icon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        const MathSpan = ({ tex, display = false }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.katex && containerRef.current) {
                    try {
                        window.katex.render(tex, containerRef.current, {
                            throwOnError: false,
                            displayMode: display,
                            trust: true
                        });
                    } catch (e) {
                        containerRef.current.textContent = tex;
                    }
                }
            }, [tex, display]);
            return <span ref={containerRef} className={display ? "block" : "inline-block"} />;
        };

        function App() {
            const [query, setQuery] = useState("");
            const [image, setImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [messages, setMessages] = useState([
                { 
                    role: 'assistant', 
                    content: 'Hello! I am **Digambar AI**. Paste an image (Ctrl+V) or type a problem, and I will solve it for you step-by-step.',
                    timestamp: new Date().toLocaleTimeString()
                }
            ]);
            const [isLoading, setIsLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTo({
                        top: scrollRef.current.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, [messages, isLoading]);

            const processFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    setImage(file);
                    const reader = new FileReader();
                    reader.onloadend = () => setImagePreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        processFile(items[i].getAsFile());
                        break;
                    }
                }
            };

            const fetchWithRetry = async (payload, retries = 5, delay = 1000) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();
                        if (response.ok) return data;
                        
                        // If it's a 429 or 5xx error, retry
                        if (response.status === 429 || response.status >= 500) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        }

                        throw new Error(data.error?.message || "Failed to process request.");
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
            };

            const solveMath = async () => {
                if (!query.trim() && !imagePreview) return;

                const userMessage = { 
                    role: 'user', 
                    content: query, 
                    image: imagePreview, 
                    timestamp: new Date().toLocaleTimeString() 
                };
                
                setMessages(prev => [...prev, userMessage]);
                
                const currentQuery = query;
                const currentImage = imagePreview;
                
                setQuery(""); 
                setImage(null); 
                setImagePreview(null);
                setIsLoading(true);

                try {
                    const prompt = currentQuery || "Please analyze this image and solve the math problem shown step-by-step with clear explanations.";
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                ...(currentImage ? [{ inlineData: { mimeType: "image/png", data: currentImage.split(',')[1] } }] : [])
                            ]
                        }],
                        systemInstruction: { 
                            parts: [{ 
                                text: "You are Digambar AI, a professional mathematics tutor. Provide clear, structured, step-by-step solutions. Always use LaTeX for mathematical notation. Wrap inline math in $...$ and display equations in $$. Break down the solution into logical steps." 
                            }] 
                        }
                    };

                    const data = await fetchWithRetry(payload);
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't generate a solution for that problem.";
                    
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: aiResponse, 
                        timestamp: new Date().toLocaleTimeString() 
                    }]);
                } catch (e) {
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: `**Error:** ${e.message}. Please try again in a moment.`, 
                        timestamp: new Date().toLocaleTimeString() 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const parseContent = (text) => {
                if (!text) return null;
                // Split by display math $$...$$ and inline math $...$
                const parts = text.split(/(\$\$.*?\$\$|\$.*?\$)/gs);
                
                return parts.map((part, i) => {
                    if (part.startsWith('$$')) return <MathSpan key={i} tex={part.slice(2, -2)} display={true} />;
                    if (part.startsWith('$')) return <MathSpan key={i} tex={part.slice(1, -1)} display={false} />;
                    
                    // Simple markdown-style bold and line breaks
                    return <span key={i} dangerouslySetInnerHTML={{ 
                        __html: part
                            .replace(/\n/g, '<br/>')
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                    }} />;
                });
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden" onPaste={handlePaste}>
                    {/* Header */}
                    <header className="h-16 border-b bg-white/80 backdrop-blur-md flex items-center justify-between px-6 shrink-0 z-50">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 p-1.5 rounded-lg text-white shadow-lg shadow-indigo-100">
                                <Icon name="calculator" size={20} />
                            </div>
                            <span className="text-xl font-bold tracking-tight">Digambar <span className="text-indigo-600">AI</span></span>
                        </div>
                        <div className="flex gap-2">
                            <Button variant="ghost" onClick={() => setMessages([messages[0]])} icon="trash-2" title="Clear Chat" />
                        </div>
                    </header>

                    {/* Chat Area */}
                    <main ref={scrollRef} className="flex-grow overflow-y-auto custom-scrollbar p-4 md:p-6 bg-slate-50">
                        <div className="max-w-3xl mx-auto space-y-6">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} message-animate`}>
                                    <div className={`p-5 rounded-3xl max-w-[90%] shadow-sm border ${
                                        msg.role === 'user' 
                                            ? 'bg-indigo-600 text-white rounded-tr-none border-indigo-500' 
                                            : 'bg-white border-slate-200 rounded-tl-none'
                                    }`}>
                                        {msg.image && (
                                            <div className="mb-4 overflow-hidden rounded-xl border border-white/20">
                                                <img src={msg.image} className="max-h-80 w-full object-contain bg-slate-100" />
                                            </div>
                                        )}
                                        <div className={`prose ${msg.role === 'user' ? 'prose-invert text-white' : 'prose-slate'} max-w-none`}>
                                            {msg.role === 'user' ? msg.content : parseContent(msg.content)}
                                        </div>
                                        <div className={`mt-3 text-[10px] uppercase font-bold tracking-widest opacity-40 text-right`}>
                                            {msg.timestamp}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start message-animate">
                                    <div className="bg-white border border-slate-200 p-4 rounded-2xl flex items-center gap-3 shadow-sm">
                                        <div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                        <span className="text-sm font-semibold text-slate-500 uppercase tracking-widest">Digambar is calculating...</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Input Area */}
                    <footer className="p-4 bg-white border-t shrink-0">
                        <div className="max-w-3xl mx-auto">
                            {imagePreview && (
                                <div className="mb-3 relative inline-block animate-in zoom-in duration-200">
                                    <img src={imagePreview} className="h-24 w-24 object-cover rounded-2xl border-4 border-white shadow-2xl ring-1 ring-slate-200" />
                                    <button 
                                        onClick={() => { setImage(null); setImagePreview(null); }} 
                                        className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 shadow-lg hover:bg-red-600 transition-colors"
                                    >
                                        <Icon name="x" size={14} />
                                    </button>
                                </div>
                            )}
                            <div className="bg-slate-100 rounded-3xl p-2 shadow-inner flex items-end ring-1 ring-slate-200 focus-within:ring-indigo-500 focus-within:bg-white transition-all duration-200">
                                <textarea
                                    value={query}
                                    onChange={e => setQuery(e.target.value)}
                                    onKeyDown={e => { 
                                        if (e.key === 'Enter' && !e.shiftKey) { 
                                            e.preventDefault(); 
                                            solveMath(); 
                                        } 
                                    }}
                                    placeholder="Type a problem or paste an image..."
                                    className="flex-grow p-3 bg-transparent outline-none resize-none max-h-40 font-medium text-slate-700 custom-scrollbar"
                                    rows={1}
                                />
                                <div className="flex gap-1 pb-1.5 pr-1.5">
                                    <label className="p-3 text-slate-500 cursor-pointer hover:bg-slate-200 rounded-2xl transition-colors">
                                        <Icon name="image" />
                                        <input 
                                            type="file" 
                                            className="hidden" 
                                            accept="image/*"
                                            onChange={e => processFile(e.target.files[0])} 
                                        />
                                    </label>
                                    <Button 
                                        onClick={solveMath} 
                                        disabled={isLoading || (!query.trim() && !imagePreview)}
                                        className="h-12 w-12 !p-0 rounded-2xl"
                                    >
                                        <Icon name="send" size={22} />
                                    </Button>
                                </div>
                            </div>
                            <p className="text-center text-[10px] text-slate-400 mt-2 font-medium uppercase tracking-widest">
                                Powered by Gemini 2.5 Flash
                            </p>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
