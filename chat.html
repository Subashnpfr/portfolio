<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Bot</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .chat-container {
            height: calc(100vh - 160px);
        }

        .message-bubble {
            max-width: 85%;
        }

        pre {
            background-color: #1e293b !important;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden">

<header class="border-b border-slate-800 p-4 bg-slate-900 flex justify-between items-center">
    <h1 class="font-bold text-lg">Gemini Assistant</h1>
    <span class="text-xs text-green-400">Secure Mode</span>
</header>

<main id="chatWindow" class="chat-container overflow-y-auto p-6 space-y-6 flex-1">
    <div class="flex justify-start">
        <div class="message-bubble bg-slate-800 p-4 rounded-2xl border border-slate-700">
            Hello! How can I help you today?
        </div>
    </div>
</main>

<footer class="p-4 border-t border-slate-800 bg-slate-900">
    <div class="max-w-4xl mx-auto flex gap-2">
        <textarea 
            id="userInput"
            rows="1"
            placeholder="Ask me anything..."
            class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
        ></textarea>

        <button 
            id="sendBtn"
            class="bg-blue-600 hover:bg-blue-500 text-white px-5 rounded-xl"
        >
            Send
        </button>
    </div>
</footer>

<script>
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true
});

function scrollToBottom() {
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function addMessage(content, isUser = false) {
    const wrapper = document.createElement('div');
    wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');
    bubble.className = `message-bubble p-4 rounded-2xl border ${
        isUser
        ? 'bg-blue-600 border-blue-500 text-white'
        : 'bg-slate-800 border-slate-700 text-slate-200'
    }`;

    if (isUser) {
        bubble.textContent = content;
    } else {
        bubble.innerHTML = marked.parse(content);
        bubble.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
        });
    }

    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

async function fetchGeminiResponse(prompt) {
    const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
    });

    if (!response.ok) {
        throw new Error("Server error");
    }

    const data = await response.json();
    return data.text;
}

async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;

    addMessage(text, true);
    userInput.value = '';
    sendBtn.disabled = true;

    try {
        const reply = await fetchGeminiResponse(text);
        addMessage(reply || "No response received.", false);
    } catch (err) {
        addMessage("Error connecting to server.", false);
    } finally {
        sendBtn.disabled = false;
    }
}

sendBtn.addEventListener('click', handleSend);

userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
    }
});
</script>

</body>
</html>
